<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div>
    <h1><%= title %></h1>
    <div>
        <button id="conBtn" onclick="initWs()">连接websocket</button>
        <button id="loginBtn" onclick="login(new Date().getTime())">请求登录</button>
        <button id="cancelBtn" onclick="onClose()">关闭连接</button>
        <button id="heartBtn" onclick="onSend()">发送心跳</button>
        <button onclick="test()">test</button>
    </div>
    <div>
        <span>登录状态</span>
        <p id="loginStatus" style="color: red">1</p>
    </div>
    <div id="qrCode">
        <%= qr %>
    </div>
</div>
</body>
</html>
<script>
    // const axios = require('axios');

    const test = () =>{
        var val = document.getElementById("loginStatus").innerHTML;
        document.getElementById("loginStatus").innerHTML += "3333"
        console.log(val)
    }

    let websocket = null

    const initWs = () => {

        if (typeof WebSocket == 'undefined') {
            alert('您的浏览器不支持该软件')
        }
        let wsUrl = `ws://192.168.0.47:9001/ws/qrCode`
        websocket = new WebSocket(wsUrl)
        websocket.onopen = onOpen
        websocket.onmessage = onMsg
        websocket.onclose = onClose
        websocket.onerror = onError
        if (websocket.readyState === 1) {
            console.log('重连成功:{}', websocket)
        }
    }
    const onOpen = (e) => {
        console.log('开启:{}', e)
    }
    const onMsg = (e) => {
        console.log('接受到消息:{}', e.data)
        let res = JSON.parse(e.data)
        // console.log('接受到消息:{}', res)
        switch (res.type) {
            case 1001:
                var val = document.getElementById("loginStatus").innerHTML;
                document.getElementById("loginStatus").innerHTML = val + `登陆成功${res.clientId}`
        }

    }
    const onSend = (e) => {
        console.log('heart', e)
        websocket.send('1')
    }
    const onClose = (e) => {
        console.log('关闭:{}', e)
    }
    const onError = (e) => {
        console.log('异常:{}', e)
    }
    const login = ()=>{
        var data = JSON.stringify({
            "clientId": new Date().getTime()
        });

        var xhr = new XMLHttpRequest();
        xhr.withCredentials = true;

        xhr.addEventListener("readystatechange", function() {
            if(this.readyState === 4) {
                console.log(this.responseText);
            }
        });

        xhr.open("POST", "/baidu/create");
        xhr.setRequestHeader("token", "232323");
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.send(data);

    }


</script>
